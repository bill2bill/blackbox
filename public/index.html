<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>volvovoyage</title>

    <style media="screen">
      body { height: 100%; overflow: hidden; overflow-y: hidden; background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #map { height: 950px; }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  </head>
  <body>
    <div id="map"></div>
    <script type="module">
      const params = new URLSearchParams(document.location.search);
      const key = params.get('key')
      const map = L.map('map').setView([51.505, -0.09], 6);

      const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js'
      import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js'

      const firebaseConfig = {
        apiKey: "AIzaSyAwDIWCsVo7R26lX86y2F9yVMDTciFJcDw",
        authDomain: "volvovoyage.firebaseapp.com",
        projectId: "volvovoyage",
        storageBucket: "volvovoyage.appspot.com",
        messagingSenderId: "247359298355",
        appId: "1:247359298355:web:a2a07c4088bed28e903c46"
      };
    
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app)

      const querySnapshot = await getDocs(collection(db, key))
      querySnapshot.forEach((doc) => {
          const data = doc.data();
          // console.log(data)
          if ((data.unix % 3 == 0) && data.lat && data.long) {
            let color = 'green'
            if(0 <= data.speed && data.speed <= 10) {
              color = 'green'
            } else if(10 <= data.speed && data.speed <= 50) {
              color = 'yellow'
            } else if(50 <= data.speed && data.speed <= 100) {
              color = 'orange'
            } else {
              color = 'red'
            }
            const circle = L.circle([data.lat, data.long], {
                color: color,
                fillColor: color,
                fillOpacity: 0.5,
                radius: data.speed * 100
            }).addTo(map);
          }
        });
    </script>
  </body>
</html>
